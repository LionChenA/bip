---
import { getCollection } from 'astro:content';
import { experimental_AstroContainer } from 'astro/container';
import { GardenList } from '../../../modules/garden';
import backlinks from '../../../modules/garden/data/backlinks.json';
import BaseLayout from '../../../modules/infra/layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('garden');
  return posts.map((post) => {
    const lang = post.data.lang || 'en';
    return {
      params: { lang, slug: post.slug },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const { Content } = await post.render();
const { lang } = Astro.params;

// Render Content for React hydration
const container = await experimental_AstroContainer.create();
const contentHtml = await container.renderToString(Content);

// Prepare all posts for the list context
const allPosts = await getCollection('garden');
const initialPosts = allPosts
  .filter((p) => p.data.lang === lang)
  .map((p) => ({
    slug: p.slug,
    title: p.data.title,
    description: p.data.description,
    pubDate: p.data.pubDate.toISOString(),
    type: p.data.type,
    lang: p.data.lang,
    tags: p.data.tags,
  }));

const initialContent = {
  content: contentHtml,
  backlinks: (backlinks as any)[post.slug] || [],
};
---

<BaseLayout title={post.data.title} description={post.data.description} lang={lang}>
  <GardenList 
    client:load 
    lang={lang}
    initialPosts={initialPosts}
    initialSlug={post.slug}
    initialContent={initialContent}
  />
</BaseLayout>
